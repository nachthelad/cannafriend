rules_version = '2';

service firebase.storage {
  function isOwner(userId) {
    return request.auth != null && request.auth.uid == userId;
  }

  match /b/{bucket}/o {
    // Imágenes por usuario: /images/{userId}/...
    match /images/{userId}/{allPaths=**} {
      // Leer y listar solo del dueño (list es opcional si no usas list())
      allow read, list: if isOwner(userId);

      // Crear (subir) con validaciones
      allow create: if isOwner(userId)
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/(jpeg|jpg|png|webp|gif)');

      // Actualizar (reemplazar objeto) con las mismas validaciones
      allow update: if isOwner(userId)
        && request.resource.size < 10 * 1024 * 1024 // Máximo 10MB por archivo
        && request.resource.contentType.matches('image/(jpeg|jpg|png|webp|gif)');

      // Borrar (para limpiar fotos al eliminar la planta)
      allow delete: if isOwner(userId);
    }

    // Denegar el resto por defecto
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
